<div class="container">



    <div class="row d-flex justify-content-lg-center ">

        <div class="card col-lg-10">

            <div class="row table-responsive">
                <table class="table bg-light table-hover text-center ">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="" id="tatca"
                                        (input)="toggleSelectionCTatCa($event)" />

                                </div>
                                <p>Tất cả</p>
                            </th>
                            <th scope="col">Ảnh</th>
                            <th scope="col" colspan="2">Sản phẩm</th>
                            <th scope="col">Size</th>
                            <th scope="col">Số ly (size)</th>
                            <th scope="col" colspan="2">Đơn giá ly (size)</th>
                            <th scope="col" colspan="3">Thao tác</th>


                        </tr>
                    </thead>

                    <tbody class="" *ngFor="let item of cart_products.GioHang; let isFirst = first">
                        <tr *ngIf="isFirst || tenCuaHang !== item.MaSP.MaCH.TenCuaHang">
                            <td colspan="10">
                                <div class="form-check d-flex align-items-center">
                                    <input class="form-check-input cuahang" type="checkbox" [id]="item.MaSP.MaCH._id"
                                        (input)="toggleSelectionCuaHang(item.MaSP.MaCH._id, $event)" />
                                    <mat-icon class="text-orange-600 ">storefront</mat-icon>
                                    <p class="" style="font-size: 20px;">
                                        {{item.MaSP.MaCH.TenCuaHang}}
                                        {{mucCuaHang(item.MaSP.MaCH.TenCuaHang)}} |
                                        {{truncateName(item.MaSP.MaCH.DiaChi, 16)}}
                                    </p>
                                </div>
                            </td>
                        </tr>


                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input sanpham" type="checkbox"
                                        [id]="item.MaSP.MaCH._id + '||' + item.MaSP._id + item.DonGiaSizeLy.Size"
                                        (input)="toggleSelectionSanPham(item, $event)" />
                                </div>
                            </td>
                            <td class="">
                                <img src="/frontend/src/assets/Images/{{item.MaSP.Hinh}}"
                                    class="w-10 rounded-circle" alt="...">
                            </td>

                            <td colspan="2">
                                <p
                                    style="font-size: 15px; text-shadow: 2px 2px 4px rgba(32, 122, 128, 0.5); color: #2286ea;">
                                    {{item.MaSP.TenSP}}
                                </p>
                            </td>

                            <td >
                                <p>{{item.DonGiaSizeLy.Size}}</p>
                            </td>

                            <td>
                                <form action="" class="d-flex align-items-center">
                                    <button type="button" data-mdb-ripple-init data-mdb-ripple-color="dark"
                                        class="btn btn-link btn-floating" (click)="giamSoLuongSanPhamGioHang(item)">
                                        <span class="material-symbols-outlined">
                                            remove
                                        </span>
                                    </button>
                                    <input style="width:55px;" type="number" min="1" max="3" class="form-control"
                                        value="{{item.DonGiaSizeLy.SL}}" (input)="thayDoiSoLuong(item, $event)"
                                        [id]="item.DonGiaSizeLy.Size + '||' + item.MaSP._id">


                                    <button type="button" data-mdb-ripple-init data-mdb-ripple-color="dark"
                                        class="btn btn-link btn-floating" (click)="tangSoLuongSanPhamGioHang(item)">

                                        <span class="material-symbols-outlined">
                                            add
                                        </span>
                                    </button>
                                </form>
                            </td>

                            <td colspan="2">
                                <div *ngIf="timKhuyenMai(item) != 0">
                                    <p><del>{{item.DonGiaSizeLy.Dongia}}</del>đ <span class="text-warning fs-6">(-{{timKhuyenMai(item)}}%)</span>
                                    </p>
                                    <p class="text-danger fs-5">{{tinhGIaKhuyenMai_SanPham(item.DonGiaSizeLy.Dongia, timKhuyenMai(item))}}đ</p>
                                </div>

                                <div *ngIf="timKhuyenMai(item) == 0">
                                    <p>{{item.DonGiaSizeLy.Dongia}}đ</p>
                                    
                                </div>
                              
                            </td>
                            <td colspan="3" class="">
                                <div class="d-flex align-items-center justify-content-lg-center">
                                    <button type="button"
                                        class="btn btn-tag btn-rounded btn-sm fw-bold d-flex align-items-center"
                                        data-mdb-ripple-color="dark" (click)="toggleCollapse(item)"
                                        style="font-size: 13px;"
                                        [attr.aria-expanded]="!isCollapsed[item.MaSP._id + item.DonGiaSizeLy.Size]"
                                        [attr.aria-controls]="item.MaSP._id + item.DonGiaSizeLy.Size">
                                        <mat-icon>layers</mat-icon>
                                        {{ !isCollapsed[item.MaSP._id + item.DonGiaSizeLy.Size] ? 'Hiện Toppings' : 'Ẩn Toppings' }}

                                    </button>

                                    <button (click)="xoa1SanPhamGioHang(item)" type="button"
                                        class="btn btn-link btn-sm fw-bold" data-mdb-ripple-init
                                        data-ripple-color="primary">
                                        <span class="material-symbols-outlined">
                                            close
                                        </span>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <tr [ngbCollapse]="!isCollapsed[item.MaSP._id + item.DonGiaSizeLy.Size]" class="fw-bold">
                            <td colspan="2"></td> <!-- Ô trống, cột 1 -->
                            <td colspan="2">Tên Topping</td> <!-- Cột 3 -->
                            <td colspan="2">Số lượng Topping</td>
                            <td colspan="1">Giá topping</td>
                            <td colspan="2">Thao tác </td>
                        </tr>

                        <tr [ngbCollapse]="!isCollapsed[item.MaSP._id + item.DonGiaSizeLy.Size]"
                            *ngFor="let item2 of item.DongiaToppings">
                            <td colspan="2"></td> <!-- Ô trống, cột 1 -->
                            <td colspan="2">{{item2.tenTopping}}</td> <!-- Cột 3 -->
                            <td colspan="2">
                                <form action="" class="d-flex justify-content-lg-center align-items-center">
                                    <button type="button" data-mdb-ripple-init data-mdb-ripple-color="dark"
                                        class="btn btn-link btn-floating"
                                        (click)="giamSoLuongSanPhamToppingGioHang(item, item2._id, item2.soluongtopping)">
                                        <span class="material-symbols-outlined">
                                            remove
                                        </span>
                                    </button>
                                    <input style="width:55px;" type="number" min="1" max="3" class="form-control"
                                        value="{{item2.soluongtopping}}"
                                        [id]="item2._id + '||' + item.DonGiaSizeLy.Size + '||' + item.MaSP._id"
                                        (input)="thayDoiSoLuongTopping(item, $event, item2._id)">

                                    <button type="button" data-mdb-ripple-init data-mdb-ripple-color="dark"
                                        class="btn btn-link btn-floating"
                                        (click)="tangSoLuongToppingSanPhamGioHang(item, item2._id, item2.soluongtopping)">

                                        <span class="material-symbols-outlined">
                                            add
                                        </span>
                                    </button>
                                </form>
                            </td>
                            <td colspan="1">{{item2.giatopping}}</td>
                            <td colspan="2" class="">
                                <button type="button" class="btn btn-link btn-sm fw-bold" data-mdb-ripple-init
                                    data-ripple-color="primary" (click)="xoa1ToppingGioHang(item, item2._id)">
                                    <span class="material-symbols-outlined">
                                        close
                                    </span>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card col-lg-2">
            <p>Tổng số ly: {{calculateSLLy()}}</p>
            <p>Tổng số topping: {{calculateSLTopping()}}</p>
            <p>Tổng giá ly: {{calculateGiaSizeLy()}}đ</p>
            <p>Tổng giá topping: {{calculateTotalGiaTopping()}}đ</p>
            <p>Tổng tiền: {{calculateTotals()}}đ</p>
        </div>
    </div>
</div>